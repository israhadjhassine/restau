<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panier - FoodDelivery</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; line-height: 1.6; color: #333; }
        .navbar { background: #e44d26; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; color: white; }
        .nav-links a { color: white; text-decoration: none; margin-left: 2rem; padding: 0.5rem 1rem; border-radius: 4px; transition: background 0.3s; }
        .nav-links a:hover { background: rgba(255,255,255,0.2); }
        .container { max-width: 800px; margin: 2rem auto; padding: 0 2rem; }
        .cart-item { border: 1px solid #ddd; padding: 1rem; margin: 1rem 0; display: flex; justify-content: space-between; align-items: center; }
        .quantity-controls { display: flex; align-items: center; gap: 10px; }
        .quantity-btn { background: #e44d26; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
        .checkout-btn { background: #e44d26; color: white; padding: 1rem 2rem; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1rem; margin-top: 1rem; }
        .checkout-btn:disabled { background: #ccc; cursor: not-allowed; }
        .login-prompt { background: #fff3cd; border: 1px solid #ffeaa7; padding: 1rem; border-radius: 5px; margin: 1rem 0; }
        .remove-btn { background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-left: 10px; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <h2><a href="/" style="color: white; text-decoration: none;">FoodDelivery</a></h2>
        </div>
        <div class="nav-links">
            <a href="/client/restaurants">Restaurants</a>
            <% if (user) { %>
                <!-- Logged in user -->
                <a href="/client/cart">Panier</a>
                <a href="/client/home-private">Mon Compte</a>
                <a href="/logout">Déconnexion</a>
            <% } else { %>
                <!-- Guest user -->
                <a href="/login">Connexion</a>
                <a href="/signup">Inscription</a>
            <% } %>
        </div>
    </nav>

    <div class="container">
        <h1>Votre Panier</h1>
        
        <!-- Login prompt for guests -->
        <% if (!user) { %>
            <div class="login-prompt">
                <p>Vous devez être connecté pour passer commande.</p>
                <a href="/login" style="color: #e44d26; font-weight: bold;">Se connecter</a> ou 
                <a href="/signup" style="color: #e44d26; font-weight: bold;">S'inscrire</a>
            </div>
        <% } %>
        
        <% if (cart && cart.length > 0) { %>
            <!-- Restaurant info -->
            <% if (cart[0].nomRestaurant) { %>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                    <h3>Commande chez: <%= cart[0].nomRestaurant %></h3>
                </div>
            <% } %>

            <!-- Cart items -->
            <% cart.forEach(function(item) { %>
                <div class="cart-item">
                    <div>
                        <h3><%= item.nom || item.name %></h3>
                        <p>Prix unitaire: <%= item.prix || item.price %> DT</p>
                    </div>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="updateQuantity('<%= item.itemId || item.id %>', getNewQuantity('<%= item.quantite || item.quantity %>', -1))">-</button>
                        <span style="margin: 0 10px;"><%= item.quantite || item.quantity || 1 %></span>
                        <button class="quantity-btn" onclick="updateQuantity('<%= item.itemId || item.id %>', getNewQuantity('<%= item.quantite || item.quantity %>', 1))">+</button>
                        <button class="remove-btn" onclick="removeItem('<%= item.itemId || item.id %>')">×</button>
                    </div>
                    <div>
                        <% 
                            const prix = parseFloat(item.prix || item.price || 0);
                            const quantite = parseInt(item.quantite || item.quantity || 1);
                            const itemTotal = prix * quantite;
                        %>
                        <p><strong>Total: <%= itemTotal.toFixed(2) %> DT</strong></p>
                    </div>
                </div>
            <% }); %>

            <!-- Total and checkout -->
            <div style="text-align: right; margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #ddd;">
                <h3>Total: <%= total %> DT</h3>

                <% if (user) { %>
                    <form action="/client/passerCommande" method="POST">
                        <button type="submit" class="checkout-btn">Passer la commande</button>
                    </form>
                <% } else { %>
                    <button class="checkout-btn" disabled>Connectez-vous pour commander</button>
                <% } %>
            </div>

            <!-- Clear cart button -->
            <div style="text-align: left; margin-top: 1rem;">
                <button onclick="clearCart()" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer;">
                    Vider le panier
                </button>
            </div>

        <% } else { %>
            <p>Votre panier est vide</p>
            <a href="/client/restaurants" style="color: #e44d26; font-weight: bold;">Voir les restaurants</a>
        <% } %>
    </div>

    <script>
        function getNewQuantity(currentQuantite, change) {
            const quantite = parseInt(currentQuantite) || 1;
            const newQuantite = quantite + change;
            return newQuantite < 1 ? 1 : newQuantite;
        }

        function updateQuantity(itemId, newQuantite) {
            console.log("Updating quantity for item", itemId, "to", newQuantite);
            
            fetch('/client/cart/update', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    itemId: itemId, 
                    quantite: parseInt(newQuantite) 
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log("Update response:", data);
                if (data.success) {
                    location.reload();
                } else {
                    alert('Erreur: ' + (data.message || 'Erreur inconnue'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erreur lors de la mise à jour de la quantité');
            });
        }

        function removeItem(itemId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet article?')) {
                fetch('/client/cart/remove', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        itemId: itemId 
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Erreur: ' + (data.message || 'Erreur inconnue'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Erreur lors de la suppression de l\'article');
                });
            }
        }

        function clearCart() {
            if (confirm('Êtes-vous sûr de vouloir vider votre panier?')) {
                fetch('/client/cart/clear', { 
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Erreur: ' + (data.message || 'Erreur inconnue'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Erreur lors du vidage du panier');
                });
            }
        }
    </script>
</body>
</html>